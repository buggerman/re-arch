#!/bin/bash
#
# Re-Arch Single Command Installer
# Professional, opinionated Arch Linux installer
# https://re-arch.xyz
#

set -euo pipefail

# Debug mode - uncomment for troubleshooting
# set -x

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Logging functions
info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

error() {
    echo -e "${RED}âŒ $1${NC}" >&2
    echo "Script failed at line $BASH_LINENO. Check the error above." >&2
    exit 1
}

# Validation functions
check_environment() {
    info "Validating installation environment..."
    
    # Check if running as root
    if [[ $EUID -ne 0 ]]; then
        error "This script must be run as root. Use: sudo bash"
    fi
    
    # Check if archinstall is available
    if ! command -v archinstall &> /dev/null; then
        error "archinstall not found. Are you running from Arch installation media?"
    fi
    
    # Check internet connectivity
    if ! ping -c 1 archlinux.org &>/dev/null; then
        error "No internet connection. Please connect to the internet first."
    fi
    
    # Check if we're in a live environment (basic check)
    if [[ ! -f /etc/arch-release ]]; then
        error "This doesn't appear to be an Arch Linux environment."
    fi
    
    success "Environment validation passed"
}

# Main installation function
run_installation() {
    echo ""
    echo "ðŸš€ Re-Arch Single Command Installer"
    echo "===================================="
    echo ""
    info "Professional Arch Linux desktop system installation"
    echo ""
    
    warning "This will install a complete desktop system with:"
    echo "  â€¢ KDE Plasma desktop environment"
    echo "  â€¢ Linux Zen kernel for performance" 
    echo "  â€¢ Automatic Btrfs snapshots"
    echo "  â€¢ Security and optimization packages"
    echo ""
    warning "Default credentials: user/rearch (change after first login)"
    echo ""
    
    # Check if running in non-interactive mode (piped from curl)
    if [[ -t 0 ]]; then
        # Interactive mode - ask for confirmation
        read -p "Continue with installation? [y/N]: " -n 1 -r
        echo ""
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo "Installation cancelled."
            exit 0
        fi
    else
        # Non-interactive mode - auto-proceed with warning
        warning "Running in non-interactive mode - proceeding automatically"
        echo "To cancel, press Ctrl+C within 5 seconds..."
        sleep 5
    fi
    
    echo ""
    info "Step 1/2: Installing base system with archinstall..."
    echo "This may take 10-20 minutes depending on your internet connection."
    echo ""
    
    # Download and verify configs first
    info "Downloading configuration files..."
    if ! curl -fsSL https://re-arch.xyz/config.json > /tmp/re-arch-config.json; then
        error "Failed to download config.json"
    fi
    if ! curl -fsSL https://re-arch.xyz/creds.json > /tmp/re-arch-creds.json; then
        error "Failed to download creds.json"
    fi
    
    # Auto-detect the primary disk
    info "Detecting available disks..."
    PRIMARY_DISK=$(lsblk -dnpo NAME,SIZE,TYPE | grep "disk" | head -1 | awk '{print $1}')
    if [[ -z "$PRIMARY_DISK" ]]; then
        error "No disks detected. Please check your system."
    fi
    
    info "Using disk: $PRIMARY_DISK"
    warning "This will ERASE ALL DATA on $PRIMARY_DISK"
    
    # Update config with detected disk
    sed -i "s|/dev/sda|$PRIMARY_DISK|g" /tmp/re-arch-config.json
    
    info "Configuration files prepared successfully"
    
    # Run archinstall with local configs for better reliability
    if archinstall --config /tmp/re-arch-config.json --creds /tmp/re-arch-creds.json; then
        success "Base system installation completed"
    else
        error "archinstall failed. Check the output above for details."
    fi
    
    echo ""
    info "Step 2/2: Optimizing system configuration..."
    echo "Configuring snapshots, services, and final optimizations..."
    echo ""
    
    # Check if /mnt exists and is mounted
    if ! mountpoint -q /mnt; then
        error "Installation target /mnt is not mounted. archinstall may have failed."
    fi
    
    # Run optimization script in chroot
    if arch-chroot /mnt bash -c "curl -fsSL https://re-arch.xyz/re-arch-lite.sh | bash"; then
        success "System optimization completed"
    else
        warning "Optimization script failed, but base system is installed"
        warning "You can manually run the optimization after reboot:"
        warning "curl -fsSL https://re-arch.xyz/re-arch-lite.sh | bash"
    fi
    
    echo ""
    echo "ðŸŽ‰ Installation Complete!"
    echo "========================"
    echo ""
    success "Your optimized Arch Linux desktop is ready!"
    echo ""
    info "Next steps:"
    echo "  1. Remove the installation USB/CD"
    echo "  2. Reboot your system"
    echo "  3. Login with: user / rearch"
    echo "  4. Change your password: passwd"
    echo "  5. Enjoy your new system!"
    echo ""
    
    # Check if running in non-interactive mode for reboot prompt
    if [[ -t 0 ]]; then
        # Interactive mode - ask about reboot
        read -p "Reboot now? [y/N]: " -n 1 -r
        echo ""
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            echo "Rebooting in 3 seconds..."
            sleep 3
            reboot
        else
            echo "Remember to reboot when ready!"
        fi
    else
        # Non-interactive mode - just remind to reboot
        echo "Remember to reboot when ready!"
        echo "Run: reboot"
    fi
}

# Main execution
main() {
    check_environment
    run_installation
}

# Always run main function when script is executed
main "$@"