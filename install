#!/bin/bash
#
# Re-Arch: Simple Arch Linux Desktop Installer
# One-command installation with desktop environment choice
# https://re-arch.xyz
#

set -euo pipefail

# Debug mode - set RE_ARCH_DEBUG=1 for verbose output
if [[ "${RE_ARCH_DEBUG:-0}" == "1" ]]; then
    set -x
    info "Debug mode enabled - verbose output active"
fi

# Base URL configuration
# Can be overridden with: RE_ARCH_BASE_URL="./" ./install
BASE_URL="${RE_ARCH_BASE_URL:-https://re-arch.xyz}"

# Remove trailing slash if present
BASE_URL="${BASE_URL%/}"

# Helper function to download files (handles both URLs and local paths)
download_file() {
    local source="$1"
    local destination="$2"
    local description="$3"
    
    if [[ "$source" =~ ^https?:// ]]; then
        # Remote URL - use curl with timeout
        curl -fsSL --connect-timeout 10 --max-time 30 "$source" > "$destination" || {
            error "Failed to download $description from $source. Check internet connection."
        }
    elif [[ -f "$source" ]]; then
        # Local file - copy directly
        cp "$source" "$destination" || {
            error "Failed to copy $description from $source."
        }
    else
        error "Cannot find $description at $source (not a valid URL or local file)"
    fi
}

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Logging functions
info() { echo -e "${BLUE}‚ÑπÔ∏è  $1${NC}"; }
success() { echo -e "${GREEN}‚úÖ $1${NC}"; }
warning() { echo -e "${YELLOW}‚ö†Ô∏è  $1${NC}"; }
error() { echo -e "${RED}‚ùå $1${NC}" >&2; exit 1; }


# Desktop environment selection
select_desktop() {
    echo ""
    echo "üé® Choose Desktop Environment:"
    echo "1) KDE Plasma (recommended - modern, feature-rich)"
    echo "2) GNOME (clean, user-friendly)"
    echo "3) XFCE (lightweight, traditional)"
    echo "4) Hyprland (tiling window manager)"
    echo ""
    
    while true; do
        read -r -p "Enter choice [1-4]: " choice
        case $choice in
            1) echo "kde"; break ;;
            2) echo "gnome"; break ;;
            3) echo "xfce"; break ;;
            4) echo "hyprland"; break ;;
            *) warning "Invalid choice. Please enter 1-4." ;;
        esac
    done
}

# Disk detection and selection
select_disk() {
    info "Available disks:"
    lsblk -dnpo NAME,SIZE,MODEL | grep "disk" | nl -v1
    
    echo ""
    local disks
    mapfile -t disks < <(lsblk -dnpo NAME | grep -E "(sd[a-z]|nvme[0-9]+n[0-9]+|vd[a-z])$")
    
    if [ ${#disks[@]} -eq 1 ]; then
        info "Auto-selecting: ${disks[0]}"
        echo "${disks[0]}"
        return
    fi
    
    while true; do
        read -r -p "Select disk number [1-${#disks[@]}]: " num
        if [[ "$num" =~ ^[0-9]+$ ]] && [ "$num" -ge 1 ] && [ "$num" -le "${#disks[@]}" ]; then
            echo "${disks[$((num-1))]}"
            break
        fi
        warning "Invalid selection. Enter a number between 1 and ${#disks[@]}."
    done
}
# Main installation function
main() {
    echo ""
    echo "üöÄ Re-Arch: Simple Arch Linux Desktop Installer"
    echo "================================================"
    echo ""
    
    # Validate environment
    info "Validating installation environment..."
    [[ $EUID -eq 0 ]] || error "Must run as root. Use: sudo bash"
    command -v archinstall >/dev/null || error "archinstall not found. Are you on Arch installation media?"
    
    # Test internet with timeout
    if ! timeout 10 ping -c 1 archlinux.org >/dev/null 2>&1; then
        error "No internet connection. Please connect first."
    fi
    
    [[ -f /etc/arch-release ]] || error "This doesn't appear to be Arch Linux."
    
    # Check if archinstall is functional
    if ! archinstall --help >/dev/null 2>&1; then
        error "archinstall is not working properly. Try updating the Arch ISO."
    fi
    
    success "Environment validation passed"
    
    # Get user choices
    info "Getting installation preferences..."
    local desktop
    desktop=$(select_desktop)
    success "Desktop environment selected: $desktop"
    
    local disk
    disk=$(select_disk)
    success "Target disk selected: $disk"
    
    # Show summary and confirm
    echo ""
    warning "Installation Summary:"
    echo "  ‚Ä¢ Desktop Environment: $desktop"
    echo "  ‚Ä¢ Target Disk: $disk (ALL DATA WILL BE ERASED)"
    echo "  ‚Ä¢ Installation Time: ~25-35 minutes"
    echo "  ‚Ä¢ Default Login: user/rearch"
    echo ""
    
    read -r -p "Type 'YES' to continue or 'NO' to cancel: " confirm
    case "$confirm" in
        "YES") info "Starting installation..." ;;
        "NO"|*) echo "Installation cancelled."; exit 0 ;;
    esac
    
    # Clean disk to prevent issues
    info "Preparing disk $disk (this may take a few seconds)..."
    
    # Show current disk state if debug mode
    if [[ "${RE_ARCH_DEBUG:-0}" == "1" ]]; then
        info "Current disk state:"
        lsblk "$disk" || true
    fi
    
    wipefs -af "$disk" 2>/dev/null || true
    if command -v sgdisk >/dev/null; then
        sgdisk --zap-all "$disk" 2>/dev/null || true
    fi
    partprobe "$disk" 2>/dev/null || true
    sleep 2
    
    success "Disk preparation completed"
    
    # Prepare archinstall URLs
    info "Preparing installation for $desktop..."
    local config_url="${BASE_URL}/config-${desktop}.json"
    local creds_url="${BASE_URL}/creds.json"
    
    # Handle disk customization - we need to modify the config if disk != /dev/sda
    if [ "$disk" != "/dev/sda" ]; then
        info "Customizing config for disk: $disk"
        
        # Download config to modify disk setting
        download_file "$config_url" "/tmp/config.json" "configuration file"
        
        # Validate JSON syntax
        if ! python3 -m json.tool "/tmp/config.json" >/dev/null 2>&1; then
            error "Downloaded configuration file has invalid JSON syntax"
        fi
        
        # Update disk in config
        sed -i "s|/dev/sda|$disk|g" /tmp/config.json
        
        # Validate modified JSON
        if ! python3 -m json.tool "/tmp/config.json" >/dev/null 2>&1; then
            error "Modified configuration file has invalid JSON syntax"
        fi
        
        # Use local modified config
        config_url="/tmp/config.json"
        info "Using modified config with disk: $disk"
    fi
    
    # Show what we're using
    info "Config URL: $config_url"
    info "Creds URL: $creds_url"
    
    # Validate URLs/files exist before passing to archinstall
    info "Validating configuration files..."
    if [[ "$config_url" =~ ^https?:// ]]; then
        # Remote URL - test with curl and timeout
        if ! timeout 15 curl -fsSL --head "$config_url" >/dev/null; then
            error "Cannot access configuration at $config_url - check internet or try manual installation"
        fi
        if ! timeout 15 curl -fsSL --head "$creds_url" >/dev/null; then
            error "Cannot access credentials at $creds_url - check internet or try manual installation"
        fi
    else
        # Local file - check existence
        if [ ! -f "$config_url" ]; then
            error "Configuration file not found: $config_url"
        fi
        if [ ! -f "$creds_url" ]; then
            error "Credentials file not found: $creds_url"
        fi
    fi
    
    success "Configuration files validated"
    
    # Run archinstall with appropriate options
    info "Starting archinstall (this may take 15-25 minutes)..."
    info "Progress will be shown by archinstall - please be patient"
    warning "If this appears to hang for >5 minutes with no output, press Ctrl+C and use manual method"
    
    echo ""
    info "Starting in 3 seconds... (Ctrl+C to cancel)"
    sleep 3
    
    # Determine the right archinstall command based on config type
    if [[ "$config_url" =~ ^https?:// ]]; then
        # Remote URLs - use --config-url and --creds-url
        info "‚ñ∂Ô∏è  Executing: archinstall --config-url $config_url --creds-url $creds_url"
        info "üìã Manual equivalent available in error message if this fails"
        
        # Use timeout to prevent indefinite hanging
        if ! timeout 2400 archinstall --config-url "$config_url" --creds-url "$creds_url"; then
            echo ""
            error "archinstall failed or timed out after 40 minutes.
            
üîß Try manual installation:
            1. archinstall --config-url $config_url --creds-url $creds_url
            2. After completion: arch-chroot /mnt
            3. curl -fsSL ${BASE_URL}/re-arch-lite.sh | bash
            4. exit && umount -R /mnt && reboot
            
üêõ If issue persists, enable debug: RE_ARCH_DEBUG=1 ./install"
        fi
    else
        # Local files - use --config and --creds
        info "‚ñ∂Ô∏è  Executing: archinstall --config $config_url --creds $creds_url"
        info "üìã Manual equivalent available in error message if this fails"
        
        # Use timeout to prevent indefinite hanging
        if ! timeout 2400 archinstall --config "$config_url" --creds "$creds_url"; then
            echo ""
            error "archinstall failed or timed out after 40 minutes.
            
üîß Try manual installation:
            1. archinstall --config $config_url --creds $creds_url
            2. After completion: arch-chroot /mnt
            3. curl -fsSL ${BASE_URL}/re-arch-lite.sh | bash
            4. exit && umount -R /mnt && reboot
            
üêõ If issue persists, enable debug: RE_ARCH_DEBUG=1 ./install"
        fi
    fi
    
    success "Base system installation completed!"
    
    # Run post-configuration
    info "Running post-installation configuration..."
    
    # Check if /mnt exists and is mounted
    if ! mountpoint -q /mnt; then
        error "Installation mount point /mnt not found or not mounted. archinstall may have failed."
    fi
    
    # Handle post-config script execution  
    local lite_script_url="${BASE_URL}/re-arch-lite.sh"
    
    info "Downloading post-installation script..."
    # Always download the script first to avoid issues in chroot
    download_file "$lite_script_url" "/tmp/re-arch-lite.sh" "post-installation script"
    
    # Copy to mounted system
    cp /tmp/re-arch-lite.sh /mnt/tmp/re-arch-lite.sh
    chmod +x /mnt/tmp/re-arch-lite.sh
    
    info "Running post-configuration script..."
    if ! timeout 600 arch-chroot /mnt bash /tmp/re-arch-lite.sh; then
        warning "Post-configuration had issues or timed out, but system should still be bootable"
        warning "You can manually run: arch-chroot /mnt && bash /tmp/re-arch-lite.sh"
    else
        success "Post-configuration completed successfully!"
    fi
    
    success "Installation complete!"
    echo ""
    info "Next steps:"
    echo "1. umount -R /mnt && reboot"
    echo "2. Login with: user/rearch (change password immediately)"
    echo "3. Install web browser: flatpak install flathub org.mozilla.firefox"
    echo "4. Update system: sudo pacman -Syu"
    echo ""
    success "Your optimized Arch Linux desktop is ready!"
}

main "$@"
