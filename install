#!/bin/bash
#
# Re-Arch: Simple Arch Linux Desktop Installer
# One-command installation with desktop environment choice
# https://re-arch.xyz
#

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Logging functions
info() { echo -e "${BLUE}ℹ️  $1${NC}"; }
success() { echo -e "${GREEN}✅ $1${NC}"; }
warning() { echo -e "${YELLOW}⚠️  $1${NC}"; }
error() { echo -e "${RED}❌ $1${NC}" >&2; exit 1; }


# Desktop environment selection
select_desktop() {
    echo ""
    echo "🎨 Choose Desktop Environment:"
    echo "1) KDE Plasma (recommended - modern, feature-rich)"
    echo "2) GNOME (clean, user-friendly)"
    echo "3) XFCE (lightweight, traditional)"
    echo "4) Hyprland (tiling window manager)"
    echo ""
    
    while true; do
        read -r -p "Enter choice [1-4]: " choice
        case $choice in
            1) echo "kde"; break ;;
            2) echo "gnome"; break ;;
            3) echo "xfce"; break ;;
            4) echo "hyprland"; break ;;
            *) warning "Invalid choice. Please enter 1-4." ;;
        esac
    done
}

# Disk detection and selection
select_disk() {
    info "Available disks:"
    lsblk -dnpo NAME,SIZE,MODEL | grep "disk" | nl -v1
    
    echo ""
    local disks
    mapfile -t disks < <(lsblk -dnpo NAME | grep -E "(sd[a-z]|nvme[0-9]+n[0-9]+|vd[a-z])$")
    
    if [ ${#disks[@]} -eq 1 ]; then
        info "Auto-selecting: ${disks[0]}"
        echo "${disks[0]}"
        return
    fi
    
    while true; do
        read -r -p "Select disk number [1-${#disks[@]}]: " num
        if [[ "$num" =~ ^[0-9]+$ ]] && [ "$num" -ge 1 ] && [ "$num" -le "${#disks[@]}" ]; then
            echo "${disks[$((num-1))]}"
            break
        fi
        warning "Invalid selection. Enter a number between 1 and ${#disks[@]}."
    done
}
# Main installation function
main() {
    echo ""
    echo "🚀 Re-Arch: Simple Arch Linux Desktop Installer"
    echo "================================================"
    echo ""
    
    # Validate environment
    info "Validating installation environment..."
    [[ $EUID -eq 0 ]] || error "Must run as root. Use: sudo bash"
    command -v archinstall >/dev/null || error "archinstall not found. Are you on Arch installation media?"
    ping -c 1 archlinux.org >/dev/null || error "No internet connection. Please connect first."
    [[ -f /etc/arch-release ]] || error "This doesn't appear to be Arch Linux."
    
    success "Environment validation passed"
    
    # Get user choices
    local desktop
    desktop=$(select_desktop)
    local disk
    disk=$(select_disk)
    
    # Show summary and confirm
    echo ""
    warning "Installation Summary:"
    echo "  • Desktop Environment: $desktop"
    echo "  • Target Disk: $disk (ALL DATA WILL BE ERASED)"
    echo "  • Installation Time: ~25-35 minutes"
    echo "  • Default Login: user/rearch"
    echo ""
    
    read -r -p "Type 'YES' to continue or 'NO' to cancel: " confirm
    case "$confirm" in
        "YES") info "Starting installation..." ;;
        "NO"|*) echo "Installation cancelled."; exit 0 ;;
    esac
    
    # Clean disk to prevent issues
    info "Preparing disk $disk..."
    wipefs -af "$disk" 2>/dev/null || true
    if command -v sgdisk >/dev/null; then
        sgdisk --zap-all "$disk" 2>/dev/null || true
    fi
    partprobe "$disk" 2>/dev/null || true
    sleep 2
    
    # Download and customize config
    info "Downloading configuration for $desktop..."
    curl -fsSL "https://re-arch.xyz/config-${desktop}.json" > /tmp/config.json || \
        error "Failed to download configuration. Check internet connection."
    curl -fsSL "https://re-arch.xyz/creds.json" > /tmp/creds.json || \
        error "Failed to download credentials file."
    
    # Update disk in config
    sed -i "s|/dev/sda|$disk|g" /tmp/config.json
    
    # Run archinstall
    info "Running archinstall (this may take 15-25 minutes)..."
    printf "n\n" | archinstall --config /tmp/config.json --creds /tmp/creds.json || {
        error "archinstall failed. Common solutions:
1. Check internet connection
2. Ensure disk has enough space (20GB+)
3. Try rebooting and running again
4. Check the error output above for specific issues"
    }
    
    success "Base system installation completed!"
    
    # Run post-configuration
    info "Running post-installation configuration..."
    arch-chroot /mnt curl -fsSL https://re-arch.xyz/re-arch-lite.sh | arch-chroot /mnt bash || {
        warning "Post-configuration had issues but system should still be bootable"
    }
    
    success "Installation complete!"
    echo ""
    info "Next steps:"
    echo "1. umount -R /mnt && reboot"
    echo "2. Login with: user/rearch (change password immediately)"
    echo "3. Install web browser: flatpak install flathub org.mozilla.firefox"
    echo "4. Update system: sudo pacman -Syu"
    echo ""
    success "Your optimized Arch Linux desktop is ready!"
}

main "$@"
